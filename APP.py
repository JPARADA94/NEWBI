# -*- coding: utf-8 -*-
"""Untitled10.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1lmTPrriyNiVTgVm4pFyATqQdf-7OGMoi
"""

import streamlit as st
import pandas as pd

# â€”â€”â€”â€”â€”â€” ConfiguraciÃ³n de pÃ¡gina â€”â€”â€”â€”â€”â€”
st.set_page_config(page_title="Reordenador Excel MobilServ v2.0", layout="wide")
st.title("ğŸ“Š Reordenador Excel a formato MobilServ â€“ VersiÃ³n 2.0")
st.markdown("**Creado por:** Javier Parada  \n**Ingeniero de Soporte en Campo**")

# â€”â€”â€”â€”â€”â€” Instrucciones â€”â€”â€”â€”â€”â€”
st.markdown("""
### ğŸ§¾ Instrucciones de uso:
1. Sube el archivo Excel (.xlsx) con los datos originales.
2. El sistema validarÃ¡ automÃ¡ticamente los nombres de las columnas.
3. Si hay columnas con nombres modificados o en orden incorrecto, recibirÃ¡s una advertencia.
4. Si todo estÃ¡ correcto, podrÃ¡s continuar al reordenamiento y descarga del archivo limpio.
""")

# â€”â€”â€”â€”â€”â€” Utilitario: convertir letra columna Excel a Ã­ndice â€”â€”â€”â€”â€”â€”
def col_letter_to_index(letter: str) -> int:
    idx = 0
    for c in letter.upper():
        idx = idx * 26 + (ord(c) - ord("A") + 1)
    return idx - 1

# â€”â€”â€”â€”â€”â€” Encabezados esperados (Columna â†’ Nombre encabezado) â€”â€”â€”â€”â€”â€”
encabezados_esperados = {
    "A": "NOMBRE_CLIENTE", "Y": "ESTADO", "H": "FECHA_INFORME", "U": "COMPONENTE",
    "X": "DESCRIPTOR_COMPONENTE", "Z": "NIVEL_DE_SERVICIO", "V": "MARCA_COMPONENTE",
    "W": "MODELO_COMPONENTE", "E": "FECHA_MUESTREO", "F": "FECHA_INGRESO",
    "G": "FECHA_RECEPCION", "I": "EDAD_COMPONENTE", "J": "UNIDAD_EDAD_COMPONENTE",
    "K": "EDAD_PRODUCTO", "L": "UNIDAD_EDAD_PRODUCTO", "M": "CANTIDAD_ADICIONADA",
    "N": "UNIDAD_CANTIDAD_ADICIONADA", "O": "PRODUCTO", "B": "NOMBRE_OPERACION",
    "IO": "ÃNDICE PQ (PQI) - 3", "MI": "PLATA (AG) - 19", "AJ": "ALUMINIO (AL) - 20",
    "FK": "CROMO (CR) - 24", "BV": "COBRE (CU) - 25", "IE": "HIERRO (FE) - 26",
    "OZ": "TITANIO (TI) - 38", "MK": "PLOMO (PB) - 35", "JQ": "NÃQUEL (NI) - 32",
    "JJ": "MOLIBDENO (MO) - 30", "OB": "SILICIO (SI) - 36", "OG": "SODIO (NA) - 31",
    "MM": "POTASIO (K) - 27", "PD": "VANADIO (V) - 39", "BI": "BORO (B) - 18",
    "BD": "BARIO (BA) - 21", "BM": "CALCIO (CA) - 22", "BL": "CADMIO (CD) - 23",
    "JE": "MAGNESIO (MG) - 28", "JF": "MANGANESO (MN) - 29", "HQ": "FÃ“SFORO (P) - 34",
    "PO": "ZINC (ZN) - 40", "BZ": "CÃ“DIGO ISO (4/6/14) - 47",
    "FB": "CONTEO PARTÃCULAS >= 4 ÎœM - 49", "FC": "CONTEO PARTÃCULAS >= 6 ÎœM - 50",
    "FA": "CONTEO PARTÃCULAS >= 14 ÎœM - 48", "KB": "**OXIDACIÃ“N - 80",
    "JR": "**NITRACIÃ“N - 82", "JU": "NÃšMERO ÃCIDO (AN) - 43",
    "JW": "NÃšMERO BÃSICO (BN) - 12", "JV": "NÃšMERO BÃSICO (BN) - 17",
    "IG": "**HOLLÃN - 79", "GO": "DILUCIÃ“N POR COMBUSTIBLE - 46",
    "AE": "**AGUA (IR) - 81", "CS": "CONTENIDO AGUA (KARL FISCHER) - 41",
    "ER": "CONTENIDO GLICOL  - 105", "PG": "VISCOSIDAD A 100 Â°C - 13",
    "PH": "VISCOSIDAD A 40 Â°C - 14", "C": "N_MUESTRA"
}

# â€”â€”â€”â€”â€”â€” Subida de archivo â€”â€”â€”â€”â€”â€”
uploaded = st.file_uploader("ğŸ“¤ Sube tu archivo Excel (.xlsx):", type="xlsx")

if uploaded:
    df_check = pd.read_excel(uploaded, header=0, dtype=str, nrows=0)  # solo leer encabezados
    columnas_reales = df_check.columns.tolist()

    errores = []
    for col_letter, esperado in encabezados_esperados.items():
        idx = col_letter_to_index(col_letter)
        if idx < len(columnas_reales):
            encontrado = columnas_reales[idx].strip()
            if esperado.strip() != encontrado:
                errores.append(f"- Columna {col_letter}: se esperaba **\"{esperado}\"**, se encontrÃ³ **\"{encontrado}\"**")
        else:
            errores.append(f"- Columna {col_letter}: se esperaba **\"{esperado}\"**, pero no existe en el archivo")

    if errores:
        st.error("âŒ Las siguientes columnas tienen encabezados modificados o faltantes:")
        st.markdown("\n".join(errores))
        st.stop()
    else:
        st.success("âœ… VerificaciÃ³n completada: los encabezados estÃ¡n correctos. Puedes continuar con el reordenamiento.")
        # AquÃ­ puedes continuar con la lÃ³gica de reorganizaciÃ³n